name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

env:
  GO_VERSION: '1.24'
  GO111MODULE: on

jobs:
  # 代码检查和测试
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      # buf 自带 toolchain，避免"protoc not found"
      - uses: bufbuild/buf-setup-action@v1

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - run: go mod download

      # 下载并整理依赖
      - name: Download and tidy dependencies
        run: |
          go mod download
          go mod tidy

      # 清理旧的生成文件
      - name: Clean generated files
        run: |
          rm -rf generated/slg/v1_0_0/GoSlgBenchmarkTest
          rm -rf generated/slg/v1_1_0/GoSlgBenchmarkTest
          rm -rf GoSlgBenchmarkTest/generated

      # 用 buf 生成（需 repo 根有 buf.yaml / buf.gen.yaml）
      - run: buf generate

      # 验证生成的代码并移动到正确位置
      - name: Fix generated code location
        run: |
          if [ -d "GoSlgBenchmarkTest/generated" ]; then
            mkdir -p generated
            mv GoSlgBenchmarkTest/generated/* generated/
            rm -rf GoSlgBenchmarkTest
          fi
          if [ -d "generated/slg/v1_0_0/GoSlgBenchmarkTest" ]; then
            echo "Error: Duplicate package paths detected"
            exit 1
          fi

      # 基础代码检查
      - name: Basic code checks
        env:
          GO111MODULE: on
          GOFLAGS: -mod=mod
        run: |
          go fmt ./...
          go vet ./...
          go mod verify

      - run: go test ./... -v -race -count=1 -timeout=10m
        env:
          GO111MODULE: on
          GOFLAGS: -mod=mod

      - run: |
          go test ./... -v -race -coverprofile=coverage.out -covermode=atomic -timeout=10m
          go tool cover -func=coverage.out | tail -1
        env:
          GO111MODULE: on
          GOFLAGS: -mod=mod

      - uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella

  # 基准测试
  benchmark:
    name: Benchmark
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - uses: bufbuild/buf-setup-action@v1
      - run: go mod download
      - run: |
          go mod download
          go mod tidy
      - run: buf generate
      - name: Fix generated code location
        run: |
          if [ -d "GoSlgBenchmarkTest/generated" ]; then
            mkdir -p generated
            mv GoSlgBenchmarkTest/generated/* generated/
            rm -rf GoSlgBenchmarkTest
          fi
      - run: |
          go test ./test -run=^$ -bench=. -benchmem -count=3 -timeout=10m | tee benchmark_results.txt
        env:
          GO111MODULE: on
          GOFLAGS: -mod=mod
      - uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark_results.txt

  # 模糊测试
  fuzz:
    name: Fuzz Test
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - uses: bufbuild/buf-setup-action@v1
      - run: go mod download
      - run: |
          go mod download
          go mod tidy
      - run: buf generate
      - name: Fix generated code location
        run: |
          if [ -d "GoSlgBenchmarkTest/generated" ]; then
            mkdir -p generated
            mv GoSlgBenchmarkTest/generated/* generated/
            rm -rf GoSlgBenchmarkTest
          fi
      - run: |
          # 运行每个模糊测试30秒
          go test ./test -run=^$ -fuzz=FuzzBattlePushUnmarshal -fuzztime=30s -timeout=5m
          go test ./test -run=^$ -fuzz=FuzzFrameDecode -fuzztime=30s -timeout=5m
          go test ./test -run=^$ -fuzz=FuzzPlayerActionUnmarshal -fuzztime=30s -timeout=5m
        env:
          GO111MODULE: on
          GOFLAGS: -mod=mod

  # 多平台构建测试
  build:
    name: Build
    runs-on: ${{ matrix.os }}
    needs: test
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - uses: bufbuild/buf-setup-action@v1
      - run: go mod download
      - run: |
          go mod download
          go mod tidy
      - run: buf generate
      - name: Fix generated code location
        run: |
          if [ -d "GoSlgBenchmarkTest/generated" ]; then
            mkdir -p generated
            if [ "$(uname)" = "Linux" ] || [ "$(uname)" = "Darwin" ]; then
              mv GoSlgBenchmarkTest/generated/* generated/
            else
              robocopy GoSlgBenchmarkTest/generated generated /E /MOVE || exit 0
            fi
            rm -rf GoSlgBenchmarkTest
          fi
        shell: bash
      - run: go build -v ./...
        env:
          GO111MODULE: on
          GOFLAGS: -mod=mod
      - run: go test -c ./test
        env:
          GO111MODULE: on
          GOFLAGS: -mod=mod

  # 多 Go 版本测试
  go-versions:
    name: Go Versions
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        go-version: ['1.22', '1.23', '1.24']
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
      - uses: bufbuild/buf-setup-action@v1
      - run: go mod download
      - run: |
          go mod download
          go mod tidy
      - run: buf generate
      - name: Fix generated code location
        run: |
          if [ -d "GoSlgBenchmarkTest/generated" ]; then
            mkdir -p generated
            mv GoSlgBenchmarkTest/generated/* generated/
            rm -rf GoSlgBenchmarkTest
          fi
      - run: go test ./... -v -count=1 -timeout=10m
        env:
          GO111MODULE: on
          GOFLAGS: -mod=mod
