name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

env:
  GO_VERSION: '1.25'
  GO111MODULE: on

jobs:
  # ä»£ç æ£€æŸ¥å’Œæµ‹è¯•
  test:
    name: Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      # buf è‡ªå¸¦ toolchainï¼Œé¿å…"protoc not found"
      - uses: bufbuild/buf-setup-action@v1

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - run: go mod download

      # ä¸‹è½½å¹¶æ•´ç†ä¾èµ–
      - name: Download and tidy dependencies
        run: |
          go mod download
          go mod tidy

      # æ¸…ç†æ—§çš„ç”Ÿæˆæ–‡ä»¶
      - name: Clean generated files
        run: |
          rm -rf generated/slg/v1_0_0/GoSlgBenchmarkTest
          rm -rf generated/slg/v1_1_0/GoSlgBenchmarkTest
          rm -rf GoSlgBenchmarkTest/generated

      # ç”¨ buf ç”Ÿæˆï¼ˆéœ€ repo æ ¹æœ‰ buf.yaml / buf.gen.yamlï¼‰
      - run: buf generate

      # éªŒè¯ç”Ÿæˆçš„ä»£ç å¹¶ç§»åŠ¨åˆ°æ­£ç¡®ä½ç½®
      - name: Fix generated code location
        run: |
          if [ -d "GoSlgBenchmarkTest/generated" ]; then
            mkdir -p generated
            cp -r GoSlgBenchmarkTest/generated/* generated/
            rm -rf GoSlgBenchmarkTest
          fi
          if [ -d "generated/slg/v1_0_0/GoSlgBenchmarkTest" ]; then
            echo "Error: Duplicate package paths detected"
            exit 1
          fi

      # åŸºç¡€ä»£ç æ£€æŸ¥
      - name: Basic code checks
        env:
          GO111MODULE: on
          GOFLAGS: -mod=mod
        run: |
          go fmt ./...
          go vet ./...
          go mod verify

      - run: go test ./... -v -race -count=1 -timeout=10m
        env:
          GO111MODULE: on
          GOFLAGS: -mod=mod

      # å¿«é€Ÿå•å…ƒæµ‹è¯•ï¼ˆæ’é™¤é•¿æ—¶é—´çš„WebSocketé›†æˆæµ‹è¯•ï¼‰
      - name: Run unit tests (exclude long-running WebSocket tests)
        run: |
          go test ./... -v -race -short -count=1 -timeout=6m
        env:
          GO111MODULE: on
          GOFLAGS: -mod=mod

      # ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Šï¼ˆæ’é™¤é•¿æ—¶é—´æµ‹è¯•ï¼‰
      - name: Generate coverage report (exclude long tests)
        run: |
          go test ./... -v -race -short -coverprofile=coverage.out -covermode=atomic -timeout=6m
          go tool cover -func=coverage.out | tail -1
        env:
          GO111MODULE: on
          GOFLAGS: -mod=mod

      - uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests
          name: codecov-umbrella

  # WebSocket é›†æˆæµ‹è¯•ï¼ˆç‹¬ç«‹å·¥ä½œæµï¼Œå¤„ç†é•¿æ—¶é—´è¿è¡Œæµ‹è¯•ï¼‰
  websocket_integration:
    name: WebSocket Integration Tests
    runs-on: ubuntu-latest
    needs: test  # ä¾èµ–åŸºç¡€æµ‹è¯•é€šè¿‡
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && contains(github.event.pull_request.labels.*.name, 'websocket-test'))
    timeout-minutes: 15  # è®¾ç½®15åˆ†é’Ÿè¶…æ—¶ï¼ŒåŒ…æ‹¬æœåŠ¡å™¨å¯åŠ¨å’Œæµ‹è¯•æ—¶é—´
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}

      # buf è‡ªå¸¦ toolchain
      - uses: bufbuild/buf-setup-action@v1

      - uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - run: go mod download

      # ç”Ÿæˆprotobufä»£ç 
      - run: buf generate

      # ä¿®å¤ç”Ÿæˆä»£ç ä½ç½®
      - name: Fix generated code location
        run: |
          if [ -d "GoSlgBenchmarkTest/generated" ]; then
            mkdir -p generated
            cp -r GoSlgBenchmarkTest/generated/* generated/
            rm -rf GoSlgBenchmarkTest
          fi

      # å¯åŠ¨WebSocketæµ‹è¯•æœåŠ¡å™¨ï¼ˆåå°è¿è¡Œï¼‰
      - name: Start WebSocket Test Server
        env:
          CI: true
          WS_PORT: 18090
        run: |
          # å¯åŠ¨WebSocketæœåŠ¡å™¨
          SERVER_TYPE=websocket go run tools/grpc-server.go &
          SERVER_PID=$!
          echo "SERVER_PID=$SERVER_PID" >> $GITHUB_ENV

          # ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨ï¼ˆæ›´é•¿çš„ç­‰å¾…æ—¶é—´ï¼‰
          echo "â³ ç­‰å¾…WebSocketæœåŠ¡å™¨å¯åŠ¨..."
          timeout 60 bash -c 'until nc -z localhost 18090; do sleep 2; echo "ç­‰å¾…æœåŠ¡å™¨å¯åŠ¨..."; done' || {
            echo "âŒ WebSocket server failed to start within 60 seconds"
            kill $SERVER_PID 2>/dev/null || true
            exit 1
          }
          echo "âœ… WebSocket server started successfully on port 18090"

      # è¿è¡ŒWebSocketé›†æˆæµ‹è¯•ï¼ˆå¸¦è¶…æ—¶ä¿æŠ¤ï¼‰
      - name: Run WebSocket Integration Tests
        env:
          GO_TEST_TIMEOUT: 7m
        run: |
          echo "ğŸš€ Starting WebSocket integration tests..."
          echo "â±ï¸  Test will run for approximately 5 minutes..."

          # è¿è¡Œ5åˆ†é’Ÿçš„é•¿æ—¶é—´æµ‹è¯•ï¼Œè®¾ç½®7åˆ†é’Ÿè¶…æ—¶æ—¶é—´ï¼ˆåŒ…å«é‡è¿å»¶è¿Ÿï¼‰
          go test ./test/session -v -run TestTimelineAnalysisRealWallClock \
            -timeout=${GO_TEST_TIMEOUT} \
            -parallel=1 \
            -count=1 || {
            EXIT_CODE=$?
            if [ $EXIT_CODE -eq 1 ]; then
              echo "âŒ Test failed with assertion errors"
            elif [ $EXIT_CODE -eq 124 ]; then
              echo "âŒ Test timed out after ${GO_TEST_TIMEOUT} (expected: 5m + buffer)"
            else
              echo "âŒ Test failed with exit code $EXIT_CODE"
            fi
            exit $EXIT_CODE
          }

      # è¿è¡Œå…¶ä»–WebSocketç›¸å…³æµ‹è¯•
      - name: Run Other WebSocket Tests
        run: |
          go test ./test/session -v -run "TestSessionRecordingAndReplay|TestSessionAssertions" -timeout=2m

      # æ¸…ç†åå°è¿›ç¨‹
      - name: Cleanup
        if: always()
        run: |
          if [ ! -z "$SERVER_PID" ]; then
            echo "Stopping WebSocket server (PID: $SERVER_PID)"
            kill $SERVER_PID 2>/dev/null || true
          fi

      # ä¸Šä¼ WebSocketæµ‹è¯•æŠ¥å‘Š
      - name: Upload WebSocket Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: websocket-test-results-${{ github.run_id }}
          path: |
            *.log
            test-results/
          retention-days: 7

  # åŸºå‡†æµ‹è¯•
  benchmark:
    name: Benchmark
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - uses: bufbuild/buf-setup-action@v1
      - run: go mod download
      - run: |
          go mod download
          go mod tidy
      - run: buf generate
      - name: Fix generated code location
        run: |
          if [ -d "GoSlgBenchmarkTest/generated" ]; then
            mkdir -p generated
            cp -r GoSlgBenchmarkTest/generated/* generated/
            rm -rf GoSlgBenchmarkTest
          fi
      - run: |
          go test ./test -run=^$ -bench=. -benchmem -count=3 -timeout=10m | tee benchmark_results.txt
        env:
          GO111MODULE: on
          GOFLAGS: -mod=mod
      - uses: actions/upload-artifact@v4
        with:
          name: benchmark-results
          path: benchmark_results.txt

  # æ¨¡ç³Šæµ‹è¯•
  fuzz:
    name: Fuzz Test
    runs-on: ubuntu-latest
    needs: test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
      - uses: bufbuild/buf-setup-action@v1
      - run: go mod download
      - run: |
          go mod download
          go mod tidy
      - run: buf generate
      - name: Fix generated code location
        run: |
          if [ -d "GoSlgBenchmarkTest/generated" ]; then
            mkdir -p generated
            cp -r GoSlgBenchmarkTest/generated/* generated/
            rm -rf GoSlgBenchmarkTest
          fi
      - name: Run fuzz tests
        run: |
          # è¿è¡Œæ¯ä¸ªæ¨¡ç³Šæµ‹è¯•30ç§’ï¼Œä½¿ç”¨ç²¾ç¡®åŒ¹é…é¿å…å‘½åå†²çª
          go test ./test -run=^$ -fuzz=^FuzzBattlePushUnmarshal$ -fuzztime=30s -timeout=5m
          go test ./test -run=^$ -fuzz=^FuzzLoginReqUnmarshal$ -fuzztime=30s -timeout=5m
          go test ./test -run=^$ -fuzz=^FuzzPlayerActionUnmarshal$ -fuzztime=30s -timeout=5m
          go test ./test -run=^$ -fuzz=^FuzzFrameDecode$ -fuzztime=30s -timeout=5m
          go test ./test -run=^$ -fuzz=^FuzzFrameDecoder$ -fuzztime=30s -timeout=5m
          go test ./test -run=^$ -fuzz=^FuzzErrorResp$ -fuzztime=30s -timeout=5m
        env:
          GO111MODULE: on
          GOFLAGS: -mod=mod

  # Go ç‰ˆæœ¬å…¼å®¹æ€§æµ‹è¯•ï¼ˆç²¾ç®€ç‰ˆï¼‰
  go-versions:
    name: Go Versions
    runs-on: ubuntu-latest
    needs: test
    strategy:
      matrix:
        go-version: ['1.22', '1.25']  # åªæµ‹è¯•æœ€ä½æ”¯æŒç‰ˆæœ¬å’Œå½“å‰ç‰ˆæœ¬
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: ${{ matrix.go-version }}
      - uses: bufbuild/buf-setup-action@v1
      - run: go mod download
      - run: |
          go mod download
          go mod tidy
      - run: buf generate
      - name: Fix generated code location
        run: |
          if [ -d "GoSlgBenchmarkTest/generated" ]; then
            mkdir -p generated
            cp -r GoSlgBenchmarkTest/generated/* generated/
            rm -rf GoSlgBenchmarkTest
          fi
      - run: go test ./... -v -count=1 -timeout=10m
        env:
          GO111MODULE: on
          GOFLAGS: -mod=mod
